<section class="w-full flex flex-col">
  @if (intermentsArray.isLoading()) {
  <p>Cargando...</p>
  }
  <!-- ---- -->
  @else if (intermentsArray.error()) {
  <p>
    <error-request-component />
  </p>
  }
  <!-- ---- -->

  @else if ( intermentsArray.hasValue() ) {

  <div class="flex flex-col">
    <div class="flex justify-center items-center mt-0 mb-4 sm:mt-4 sm:mb-10">
      <button class="btn btn-primary" (click)="closeModal.set(true)">
        Crear internación
      </button>
    </div>
    <div
      class="mt-2 mb-6 flex flex-col sm:flex-row sm:justify-between items-center"
    >
      <label class="input w-full sm:w-80">
        <svg
          class="h-[1em] opacity-50"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
        >
          <g
            stroke-linejoin="round"
            stroke-linecap="round"
            stroke-width="2.5"
            fill="none"
            stroke="currentColor"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </g>
        </svg>

        <input
          type="search"
          class="grow"
          [value]="searchInput()"
          #search
          (keyup.enter)="searchInput.set(search.value)"
          placeholder="Search"
        />

        <kbd class="kbd kbd-sm">⌘</kbd>
        <kbd class="kbd kbd-sm">K</kbd>
      </label>
      <div class="filter mt-2 sm:mt-0">
        <input
          class="btn filter-reset"
          type="radio"
          name="metaframeworks"
          aria-label="Todos"
          [checked]="onChangeFilter() === 'Todos'"
          (click)="onChangeFilter.set('Todos')"
          [value]="'Todos'"
        />
        <input
          class="btn btn-warning"
          type="radio"
          name="metaframeworks"
          aria-label="En espera"
          [checked]="onChangeFilter() === 'PENDING'"
          (click)="onChangeFilter.set('PENDING')"
          [value]="'PENDING'"
        />
        <input
          class="btn btn-info"
          type="radio"
          name="metaframeworks"
          aria-label="En curso"
          [checked]="onChangeFilter() === 'IN_PROGRESS'"
          (click)="onChangeFilter.set('IN_PROGRESS')"
          [value]="'IN_PROGRESS'"
        />
        <input
          class="btn btn-success"
          type="radio"
          name="metaframeworks"
          aria-label="Finalizado"
          [checked]="onChangeFilter() === 'COMPLETED'"
          (click)="onChangeFilter.set('COMPLETED')"
          [value]="'COMPLETED'"
        />
      </div>
      <!-- --------- -->
    </div>
  </div>
  <div
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
  >
    @for (data of intermentArraySignal(); track $index) {
    <article
      [routerLink]="['/interments/detail']"
      [queryParams]="{ id: data.id }"
      class="flex flex-col card bg-base-100 shadow-lg rounded-2xl p-6 border border-base-200 hover:shadow-xl transition-shadow duration-200 cursor-pointer hover:bg-base-200"
      aria-label="Detalle de internación"
    >
      <div class="flex items-center gap-4 mb-4">
        <div
          class="bg-primary/10 rounded-full w-14 h-14 flex items-center justify-center"
        >
          <i class="fa-solid fa-bed-pulse text-primary text-3xl"></i>
        </div>
        <div>
          <a
            [routerLink]="['/patients/detail']"
            [queryParams]="{ id: data?.doctor?.id }"
            class="text-lg font-bold text-base-content leading-tight mb-1 hover:underline cursor-pointer hover:text-primary"
          >
            {{ data?.patient?.name }} {{ data?.patient?.last_name }}
          </a>
          <div class="flex items-center gap-2 cursor-pointer">
            <i class="fa-solid fa-user-doctor text-secondary text-sm"></i>
            <a
              [routerLink]="['/doctors/detail']"
              [queryParams]="{ id: data?.doctor?.auth?.id }"
              class="text-sm text-secondary font-medium hover:underline hover:text-primary"
            >
              {{ data?.doctor?.auth?.full_name || "Sin doctor asignado" }}
            </a>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <div class="flex justify-between items-center">
          <label class="block text-xs text-base-content/60 mb-1"
            >Diagnóstico</label
          >
          <div class="badge badge-xs badge-neutral mb-1">
            {{
              data?.Diagnosis?.[0]?.category === "ADMISSION" ? "Admision" :
              data?.Diagnosis?.[0]?.category === "SECONDARY" ? "Secundario" :
              data?.Diagnosis?.[0]?.category === "COMPLICATION" ? "Complicación" :
              data?.Diagnosis?.[0]?.category === "COMORBIDITY" ? "Comorbilidad" :
              "Alta"
            }}
          </div>
        </div>
        <p
          class="text-sm text-base-content/80 italic overflow-hidden text-ellipsis"
          style="
            height: 6em;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            white-space: normal;
          "
        >
          {{ data?.Diagnosis?.[0]?.description || "No posee descripción aún" }}
        </p>
      </div>

      <div
        class="flex justify-between items-center mt-auto pt-4 border-t border-base-200"
      >
        <div class="flex items-center gap-2 text-xs text-base-content/60">
          <i class="fa-regular fa-calendar-days"></i>
          <span>{{ data?.admissionDate | date : "dd/MM/yyyy" }}</span>
        </div>
        <span
          class="badge px-3 py-1 text-[11px] uppercase tracking-wide font-semibold"
          [class.badge-success]="data?.status === 'COMPLETED'"
          [class.badge-error]="data?.status === 'IN_PROGRESS'"
          [class.badge-warning]="data?.status === 'PENDING'"
        >
          @if (data?.status === "COMPLETED") { Finalizado } @else if
          (data?.status === "IN_PROGRESS") { En curso } @else if (data?.status
          === "PENDING") { En espera } @else { Desconocido }
        </span>
      </div>
    </article>
    }
  </div>
  }
  <!-- --- -->
  @if ( !intermentsArray.isLoading() && !intermentsArray.error() &&
  intermentArraySignal().length === 0 ) {
  <div class="w-full flex flex-col justify-center items-center my-10">
    <div
      class="flex flex-col items-center bg-base-100 p-8 rounded-xl shadow-md border border-base-200 max-w-xl"
    >
      <i class="fa-solid fa-bed-pulse text-primary text-5xl mb-4"></i>
      <p class="text-xl text-gray-700 font-semibold text-center mb-4">
        No se encontraron pacientes internados<br />con el filtro seleccionado
      </p>
      <button
        (click)="searchInput.set(''); onChangeFilter.set('Todos')"
        class="btn btn-primary btn-md mt-2 w-full max-w-xs"
      >
        Reintentar
      </button>
    </div>
  </div>
  }
</section>

@if (closeModal()) {

<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 px-4 backdrop-blur-sm"
>
  <div
    class="w-full sm:w-[90%] md:w-[80%] lg:w-[70%] xl:w-[60%] max-w-4xl bg-base-200 rounded-2xl p-4 sm:p-6 shadow-xl animate-fade-in animate-duration-300 max-h-[90vh] overflow-y-auto"
  >
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center">
        <div class="w-1.5 h-8 bg-primary rounded-full mr-3"></div>
        <h1 class="text-xl sm:text-2xl font-bold">Crear internación</h1>
      </div>
      <button
        class="btn btn-circle btn-sm btn-ghost"
        (click)="closeModal.set(false)"
        type="button"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <form
      [formGroup]="myForm"
      (ngSubmit)="addIntermentSubmit()"
      class="space-y-6"
    >
      <div class="mb-4">
        <h2 class="text-base sm:text-lg font-semibold mb-3 text-primary">
          Información de internación
        </h2>
        <div class="divider my-0"></div>
      </div>

      <div class="form-control grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
        <div class="control">
          <label
            for="patientId"
            class="fieldset-legend text-sm font-medium flex items-center mb-1.5"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 mr-1.5 text-primary"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              />
            </svg>
            Paciente
          </label>
          <select
            class="select select-bordered w-full focus:border-primary"
            formControlName="patientId"
            [class.select-error]="
              myForm.get('patientId')?.invalid &&
              myForm.get('patientId')?.touched
            "
          >
            <option value="" disabled selected>Paciente a internar</option>
            @for (patient of patients() ?? []; track $index) {
            <option [value]="patient.id">
              {{ patient.name }} {{ patient.last_name }} | {{ patient.dni }}
            </option>
            }
          </select>
        </div>

        <div class="control">
          <label
            for="status"
            class="fieldset-legend text-sm font-medium flex items-center mb-1.5"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 mr-1.5 text-primary"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 17v-2a4 4 0 014-4h3"
              />
            </svg>
            Estado
          </label>
          <select
            class="select select-bordered w-full focus:border-primary"
            formControlName="status"
            [class.select-error]="
              myForm.get('status')?.invalid && myForm.get('status')?.touched
            "
          >
            <option value="" disabled selected>
              Seleccionar estado del paciente
            </option>
            <option value="IN_PROGRESS">En progreso</option>
            <option value="PENDING">En espera</option>
          </select>
        </div>

        <div class="control">
          <label
            for="code"
            class="fieldset-legend text-sm font-medium flex items-center mb-1.5"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 mr-1.5 text-primary"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 7h18M3 12h18M3 17h18"
              />
            </svg>
            Código de internación
          </label>
          <input
            type="text"
            class="input input-bordered w-full focus:border-primary"
            formControlName="code"
            [class.input-error]="
              myForm.get('code')?.invalid && myForm.get('code')?.touched
            "
          />
        </div>

        <div class="control">
          <label
            for="category"
            class="fieldset-legend text-sm font-medium flex items-center mb-1.5"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 mr-1.5 text-primary"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            Categoría de internación
          </label>
          <select
            name="category"
            id="category"
            class="select select-bordered w-full focus:border-primary"
            [class.select-error]="
              myForm.get('category')?.invalid && myForm.get('category')?.touched
            "
            formControlName="category"
          >
            <option value="" disabled selected>Seleccionar categoría</option>
            <option value="ADMISSION">Ingreso</option>
            <option value="SECONDARY">Secundario</option>
            <option value="COMPLICATION">Complicación</option>
            <option value="COMORBIDITY">Comorbilidad</option>
            <option value="DISCHARGE">Alta</option>
          </select>
        </div>
      </div>

      <div class="control">
        <label
          for="description"
          class="fieldset-legend text-sm font-medium flex items-center mb-1.5"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-1.5 text-primary"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 10h.01M12 10h.01M16 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          Descripción
        </label>
        <textarea
          name="description"
          id="descripcion"
          class="textarea textarea-bordered w-full focus:border-primary"
          formControlName="description"
          [class.textarea-error]="
            myForm.get('description')?.invalid &&
            myForm.get('description')?.touched
          "
        ></textarea>
      </div>

      <div class="flex justify-end mt-6">
        <button
          class="btn btn-neutral mr-2"
          (click)="closeModal.set(false)"
          type="button"
        >
          Cancelar
        </button>
        <button
          class="btn btn-primary"
          type="submit"
          [disabled]="myForm.invalid"
        >
          Crear internación
        </button>
      </div>
    </form>
  </div>
</div>

}

<toast-component [toast]="toastStatusCode()" />
